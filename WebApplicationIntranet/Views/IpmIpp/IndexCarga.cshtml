
@{
    ViewBag.Title = "Cargar de valores - IPP";
}
@Scripts.Render("~/bundles/jquery")

<h3 class="screen-title">@ViewBag.Title</h3>

<div class="panel panel-primary">
    <div class="panel-heading">B&uacute;squeda y Procesamiento</div>
    <div class="panel-body">
        <div class="row">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-addon">Año</span>
                    <select id="selAnio" name="Criteria.Año" class="form-control">
                        @for (int i = 2012; i <= DateTime.Now.Year; i++)
                        {
                            var selected = (i == DateTime.Now.Year) ? "selected" : "";
                            <option @selected value="@i">@i.ToString()</option>
                        }
                    </select>
                </div>
            </div>
            <div class="col-md-4">
                <select id="selMes" class="form-control">
                    @foreach (var fecha in ViewBag.Meses)
                    {
                        var splitFecha = @fecha.Split(',');
                        <option value="@splitFecha[0]">@splitFecha[1]</option>
                    }
                </select>
            </div>
            <div class="col-md-4">
                <input type="submit" value="Buscar" id="btnBuscar" name="btnBuscar" class="btn btn-default" />
                <input type="submit" value="Procesar" id="btnProcesar" name="btnProcesar" class="btn btn-default" />
            </div>
        </div>
    </div>
</div>

<div id="table-container">
    <table id="tblValueIpp" class="table table-striped table-hover table-bordered table-condensed tabla small">
        <thead>
            <tr class="cabecera">
                <th> Año </th>
                <th> Mes </th>
                <th> CIIU </th>
                <th> Valor IPP </th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<script type="text/javascript">
    $('#btnBuscar').on('click', function () {
        $.get('@Url.Action("GetIpp", "IpmIpp")?anio=' + $('#selAnio').val() + '&mes=' + $('#selMes').val(), function (data) {
            var $tbody = $('#tblValueIpp tbody');
            $tbody.html('');

            if (data.length === 0) {
                $tr = $('<tr><td colspan="4">No hay datos registrados en el mes de ' + $("#selMes option:selected").text() + ' del año ' + $('#selAnio').val() + '.</td></tr>');
                $tbody.append($tr);
            } else {

                for (var i = 0, len = data.length; i < len; i++) {
                    $tr = $('<tr></tr>');
                    $trAnio = $('<td></td>').text($('#selAnio').val());
                    $trMes = $('<td></td>').text($("#selMes option:selected").text());
                    $trCiiu = $('<td></td>').text(data[i].ciiu);
                    $trValor = $('<td></td>').text((data[i].valor == null) ? "" : data[i].valor);

                    $tr.append($trAnio);
                    $tr.append($trMes);
                    $tr.append($trCiiu);
                    $tr.append($trValor);

                    $tbody.append($tr);
                }
            }
        });
    });

    $('#btnProcesar').on('click', function () {
        $.post('@Url.Action("ProcessIpp", "IpmIpp")?anio=' + $('#selAnio').val() + '&mes=' + $('#selMes').val(), function (data) {
            $.smallBox({
                title: "Confirmación",
                content: "<i class='fa fa-clock-o'></i> <i>Los valores del ipp fueron actualizados</i>",
                color: "#659265",
                iconSmall: "fa fa-check fa-2x fadeInRight animated",
                timeout: 4000
            });
        });
    });
</script>