@using System.Globalization
@using Entity
@using WebApplication.Models
@using Domain
@model EncuestaEstadistica

<div class="panel panel-primary">
    <div class="panel-heading">Capítulo IV: Valor total de ventas mensuales de productos elaborados en el establecimiento</div>
    <div class="panel-body">
        <div id="errors-containervenpaext" class="alert alert-danger animated bounceIn hidden">
            <strong>Alertas</strong>
            <div>
                <ul></ul>
            </div>
        </div>
        @Html.HiddenFor(t => t.VentasProductosEstablecimiento.Identificador)
        <div class="panel panel-default">
            <div class="panel-heading">Valor de venta en el país y en el extranjero</div>
            <div class="panel-body">
                <table class="table table-striped table-hover table-bordered table-condensed tabla small">
                    <thead>
                        <tr class="cabecera">
                            <th>
                                CIIU
                            </th>
                            <th>
                                Venta pais
                            </th>
                            <th>
                                Venta extranjero
                            </th>
                        </tr>
                    </thead>

                    <tbody>
                        @foreach (var item in Model.VentasProductosEstablecimiento.DAT_VENTAS_PAIS_EXTRANJERO.OrderBy(t=>t.CAT_CIIU.ToString()))
                        {
                            <input type="hidden" class="prodEstIds" role="@item.Id" />
                            <tr>
                                <td>
                                    @item.CAT_CIIU.ToString()
                                </td>
                                <td>
                                    @if (item.VentaPaisActivado)
                                    {
                                        @Html.TextBoxFor(modelItem => item.VentaPais, new { style = "width: 100%;", @class = "mask4 form-control vpv-" + item.Id, Value = item.VentaPais.GetValueOrDefault().ProduceFormat() })
                                        if (item.justificacion_venta_pais == null)
                                        {
                                            <div class="panel justvp panel-default pnl-just div-jvp1-@item.Id" style="display: none;margin-top: 5px; ">
                                                <span>Justificaci&oacute;n</span>
                                                @Html.TextAreaFor(modelItem => item.justificacion_venta_pais, new { style = "width: 100%;", @class = "form-control jvp1-" + item.Id })
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="panel justvp panel-default pnl-just div-jvp1-@item.Id" style="margin-top: 5px; ">
                                                <span>Justificaci&oacute;n</span>
                                                @Html.TextAreaFor(modelItem => item.justificacion_venta_pais, new { style = "width: 100%;", @class = "form-control jvp1-" + item.Id })
                                            </div>
                                        }
                                    }
                                </td>
                                <td>
                                    @if (item.VentaExtranjeroActivado)
                                    {
                                        @Html.TextBoxFor(modelItem => item.VentaExtranjero, new { style = "  width: 100%;", @class = "mask4 form-control vev-" + item.Id, Value = item.VentaExtranjero.GetValueOrDefault().ProduceFormat() })
                                        if (item.justificacion_venta_ext == null)
                                        {
                                            <div class="panel justvp panel-default pnl-just div-jve1-@item.Id" style="display: none;margin-top: 5px; ">
                                                <span>Justificaci&oacute;n</span>
                                                @Html.TextAreaFor(modelItem => item.justificacion_venta_ext, new { style = "width: 100%;", @class = "form-control jve1-" + item.Id })                                            
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="panel justvp panel-default pnl-just div-jve1-@item.Id" style="margin-top: 5px; ">
                                                <span>Justificaci&oacute;n</span>
                                                @Html.TextAreaFor(modelItem => item.justificacion_venta_ext, new { style = " width: 100%;", @class = "form-control jve1-" + item.Id })
                                            </div>
                                        }
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                @if (Model.VentasProductosEstablecimiento.DAT_VENTAS_PAIS_EXTRANJERO.Any(t => t.VentaExtranjeroActivado || t.VentaPaisActivado))
                {
                    <div class="pull-right">
                        <a href="javascript:void(0);" id="edit-prodEstab" data-toggle="tooltip" data-placement="top" title="" data-original-title="Guardar" class="btn btn-primary">Guardar</a>
                    </div>
                }
                @if (!Model.VentasProductosEstablecimiento.DAT_VENTAS_PAIS_EXTRANJERO.Any())
                {
                    <div class="no-elements-notification">
                        No hay elementos para mostrar
                    </div>
                }
            </div>
        </div>
        <div id="ventaServicios">
            @{ Html.RenderPartial("_TableVentaServicios", Model.VentasProductosEstablecimiento); }
        </div>

    </div>

</div>

<script type="text/javascript">
    $(document).ready(function () {
        $('.justvp textarea').each(function (i, el) {
            var value = $(this).val().trim();
            $(this).val(value);
        });

        maskEstadistico();       
    });

    $("#edit-prodEstab").click(function (e) {
        $(".justvp").hide();
        var list = [];
        $(".prodEstIds").each(function (i, el) {
            var $elem = $(el);
            var id = $elem.attr("role");
            var vp = 0;
            if ($('.vpv-' + id)[0]) {
                vp = getValueEstadistico('.vpv-' + id);
            }
            var ve = null;
            if ($('.vev-' + id)[0]) {
                ve = getValueEstadistico('.vev-' + id);
            }
            var jvp = null;
            if ($('.jvp1-' + id)[0]) {
                jvp = $('.jvp1-' + id)[0].value;
            }
            var jve = null;
            if ($('.jve1-' + id)[0]) {
                jve = $('.jve1-' + id)[0].value;
            }
            var obj = {
                Id: id,
                VentaExtranjero: ve,
                VentaPais: vp,
                justificacion_venta_ext: jve,
                justificacion_venta_pais: jvp
            };            
            list.push(obj);
        });
        $.ajax({
            cache: false,
            dataType: "json",
            type: "POST",
            contentType: "application/json",
            url: $.origin() + "/EncuestaEstadistica/SaveVentas/",
            data: JSON.stringify({ "ventas": list }),
            success: function (data) {
                if (data.Success) {
                    $("#errors-containervenpaext").addClass("hidden");

                    for (var j = 0; j < data.Pais.length; j++) {
                        $($('.div-jvp1-' + data.Pais[j])[0]).show();
                    }
                    for (var k = 0; k < data.Extranjero.length; k++) {
                        $($('.div-jve1-' + data.Extranjero[k])[0]).show();
                    }

                    $.smallBox({
                        title: "Confirmación",
                        content: "<i class='fa fa-clock-o'></i> <i>El elemento se guardó correctamente</i>",
                        color: "#659265",
                        iconSmall: "fa fa-check fa-2x fadeInRight animated",
                        timeout: 4000
                    });
                } else {
                    var errors = "";
                    for (var i = 0; i < data.Errors.length; i++) {
                        errors += "<li>" + data.Errors[i] + "</li>";
                    }
                    for (var j = 0; j < data.Pais.length; j++) {
                        $($('.div-jvp1-' + data.Pais[j])[0]).show();
                    }
                    for (var k = 0; k < data.Extranjero.length; k++) {
                        $($('.div-jve1-' + data.Extranjero[k])[0]).show();
                    }
                    $("#errors-containervenpaext").removeClass("hidden").find("ul").html(errors);
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert('Failed to retrieve data.');
            }
        });
        e.preventDefault();
    });
</script>