@using System.Globalization
@using Entity
@using PagedList.Mvc
@model Domain.Query<Entity.EncuestaEstadistica>

@{
    ViewBag.Title = "Actualizar Encuestas Estadísticas Anteriores";
}

@section head{
    <style>
        .ui-dialog {
            z-index: 999999992 !important;
        }

        .ui-widget-overlay {
            z-index: 999999991 !important;
        }
    </style>
}

<div id="errors-container-general" class="alert alert-danger animated bounceIn hidden">
    <strong>Alertas</strong>
    <div>
        <ul></ul>
    </div>
</div>

<a href="@Url.Action("Index", "Establecimiento")" class="btn btn-primary pull-right"><i class="glyphicon glyphicon-backward"></i> Regresar</a>

<h3 class="screen-title">@ViewBag.Title (@ViewBag.Establecimiento.Ruc - @ViewBag.Establecimiento.Nombre.Trim())</h3>
@using (Html.BeginForm("SearchEncuestaForUpdate", "EncuestaEstadistica", FormMethod.Post))
{
    <div class="panel panel-primary">
        <div class="panel-heading">Búsqueda</div>
        @{
            var sel0 = Model == null || Model.Criteria == null || Model.Criteria.Mes != null ? "" : "selected";
            var sel1 = Model == null || Model.Criteria == null || Model.Criteria.Mes != 1 ? "" : "selected";
            var sel2 = Model == null || Model.Criteria == null || Model.Criteria.Mes != 2 ? "" : "selected";
            var sel3 = Model == null || Model.Criteria == null || Model.Criteria.Mes != 3 ? "" : "selected";
            var sel4 = Model == null || Model.Criteria == null || Model.Criteria.Mes != 4 ? "" : "selected";
            var sel5 = Model == null || Model.Criteria == null || Model.Criteria.Mes != 5 ? "" : "selected";
            var sel6 = Model == null || Model.Criteria == null || Model.Criteria.Mes != 6 ? "" : "selected";
            var sel7 = Model == null || Model.Criteria == null || Model.Criteria.Mes != 7 ? "" : "selected";
            var sel8 = Model == null || Model.Criteria == null || Model.Criteria.Mes != 8 ? "" : "selected";
            var sel9 = Model == null || Model.Criteria == null || Model.Criteria.Mes != 9 ? "" : "selected";
            var sel10 = Model == null || Model.Criteria == null || Model.Criteria.Mes != 10 ? "" : "selected";
            var sel11 = Model == null || Model.Criteria == null || Model.Criteria.Mes != 11 ? "" : "selected";
            var sel12 = Model == null || Model.Criteria == null || Model.Criteria.Mes != 12 ? "" : "selected";

            if (Model == null || Model.Criteria == null)
            {
                sel0 = "selected";
            }
        }
        <div class="panel-body">
            <div class="col-md-5">
                <div class="input-group">
                    <span class="input-group-addon">MES</span>                   
                    <select name="Criteria.Mes" class="form-control">
                        <option @sel0 value="null">Todos</option>
                        <option @sel1 value="1">Enero</option>
                        <option @sel2 value="2">Febrero</option>
                        <option @sel3 value="3">Marzo</option>
                        <option @sel4 value="4">Abril</option>
                        <option @sel5 value="5">Mayo</option>
                        <option @sel6 value="6">Junio</option>
                        <option @sel7 value="7">Julio</option>
                        <option @sel8 value="8">Agosto</option>
                        <option @sel9 value="9">Septiembre</option>
                        <option @sel10 value="10">Octubre</option>
                        <option @sel11 value="11">Noviembre</option>
                        <option @sel12 value="12">Diciembre</option>
                    </select>
                </div>
            </div>
            <div class="col-md-5">
                <div class="input-group">
                    <span class="input-group-addon">A&Ntilde;O</span>
                    <select id="selct-ano" name="Criteria.Year" class="form-control">
                        @for (int i = 2012; i <= DateTime.Now.Year; i++)
                        {
                            var selected = (Model.Criteria != null && Model.Criteria.Year == i || ((Model.Criteria == null || Model.Criteria.Year == null) && i == DateTime.Now.Year)) ? "selected" : "";
                            <option @selected value="@i">@i.ToString()</option>
                        }
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-2">
                    <input type="submit" value="Buscar" name="buscarbtn" class="btn btn-default" />
                </div>
            </div>
        </div>
    </div>
}

<div id="table-container">
    <table class="table table-striped table-hover table-bordered table-condensed tabla small">
        <thead>
            <tr class="cabecera">
                <th style="width: 20px;"></th>                
                <th>
                    MES
                </th>
                <th>
                    A&Ntilde;O
                </th>
                <th>ACTUALIZANDO</th>
                <th>ACCI&Oacute;N</th>
        </thead>

        <tbody>
            @foreach (var item in Model.Elements.OrderByDescending(t => t.Fecha))
            {
                <tr>
                    <td>
                        @switch (item.EstadoEncuesta)
                        {
                            case EstadoEncuesta.Enviada:<span data-toggle="tooltip" data-placement="top" data-original-title="ENVIADA @item.fecha_ultimo_envio.GetValueOrDefault().ToString("F", CultureInfo.GetCultureInfo("es"))" title=""><i class="fa fa-sign-out text-success"></i></span>
                                break;
                            case EstadoEncuesta.NoEnviada:<span data-toggle="tooltip" data-placement="top" data-original-title="NO ENVIADA" title=""><i class="glyphicon glyphicon-eye-close text-danger"></i></span>
                                break;
                            case EstadoEncuesta.Observada:<span data-toggle="tooltip" data-placement="top" data-original-title="@item.Justificacion" title=""><i class="fa fa-pencil-square-o text-warning"></i></span>
                                break;
                            case EstadoEncuesta.Validada:<span data-toggle="tooltip" data-placement="top" data-original-title="VALIDADA" title=""><i class="glyphicon glyphicon-ok text-success"></i></span>
                                break;
                        }
                    </td>                    
                    <td>
                        @item.Fecha.ToString("MMMM", CultureInfo.GetCultureInfo("es")).ToUpper()
                    </td>
                    <td>
                        @item.Fecha.Year
                    </td>
                    <td>
                        @if (item.actualizacion == 1)
                        {
                            <span data-toggle="tooltip" data-placement="top" data-original-title="ACTUALIZANDO" title=""><i class="glyphicon glyphicon-refresh text-success"></i></span>
                            if (item.EstadoEncuesta == EstadoEncuesta.Validada)
                            {
                                @Html.Raw("Permiso brindado al analista")
                            }
                            else
                            {
                                @Html.Raw("Permiso brindado al usuario")
                            }
                        }
                    </td>
                    <td>
                        @if (item.actualizacion == 0)
                        { 
                            <a href="#" data-toggle="tooltip" data-placement="top" title="" data-original-title="Brindar Permiso al Analista" data-id="@item.Id" data-permiso-analista="">
                                <i class="color-black glyphicon glyphicon-user"></i>
                            </a>
                            @Html.Raw("&#124;");
                            <a href="#" data-toggle="tooltip" data-placement="top" title="" data-original-title="Brindar Permiso al Usuario" data-id="@item.Id" data-permiso-usuario="">
                                <i class="color-black glyphicon glyphicon-user"></i><span style="color: #333; position: relative; bottom: 8px; right: 2px; text-transform: uppercase; font-size: 8px; }">E</span>
                            </a> 
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @if (Model.Elements.Count == 0)
    {
        <div class="no-elements-notification">
            No hay elementos para mostrar
        </div>
    }
    @Html.PagedListPager(Model.Elements, page => Url.Action("PageForUpdate", new { page }), PagedListRenderOptions.ClassicPlusFirstAndLast)
</div>

<div id="confirm-permiso">
    <label id="permiso-content"></label>
    <input type="hidden" id="tipo-permiso" />
    <input type="hidden" id="idEncuesta-permiso" />
</div>

@section scripts{
    <script type="text/javascript">
        $(document).ready(function() {
            var selectAno = $("#selct-ano");
            $.search(selectAno);
            $.InitTooltip();
        });

        $('[data-permiso-analista],[data-permiso-usuario]').click(function (e) {
            e.preventDefault();
            var $tr = $(this).parent().parent();
            var mes = $tr.find('td:eq(1)').text().trim();
            var anio = $tr.find('td:eq(2)').text().trim();
            $('#idEncuesta-permiso').val($(this).attr('data-id'));
            var msg = '¿Está seguro que desea brindar permiso XXXXX para la encuesta ' + mes + ' - '+ anio + '?';

            if ($(this).attr('data-permiso-analista') != null) {
                msg = msg.replace('XXXXX', 'al analista');
                $('#tipo-permiso').val(1);
            } else {
                msg = msg.replace('XXXXX', 'al usuario');
                $('#tipo-permiso').val(0);
            }

            $('#permiso-content').text(msg);

            $("#confirm-permiso").dialog("open");

            var title = $(this).attr('data-original-title');
            $('.ui-dialog-title').text(title);
        });

        $('#confirm-permiso').dialog({
            autoOpen: false,
            resizable: false,
            draggable: false,
            modal: true,
            buttons: {
                'Brindar Permiso': function () {
                    @*$('#btnConfirmClean').addClass('disabled');
                    $.post(window.location.origin + '/EncuestaEstadistica/Recreate/@Request.QueryString["idEncuesta"]', function (data) {                        
                        window.location = '@Request.Url.AbsoluteUri'.replace('=@Request.QueryString["idEncuesta"]', '=' + data);                        
                    });*@

                    $('#btnBrindarPermiso').addClass('disabled');
                    $.post('@Url.Action("OpenForUpdate", "EncuestaEstadistica")', { idEncuesta: $('#idEncuesta-permiso').val(), tipoPermiso: $('#tipo-permiso').val() }, function (response) {
                        var data = {};
                        $('#btnBrindarPermiso').removeClass('disabled');
                        if (response == "1") {
                            window.location.reload();
                        } else {
                            $("#confirm-permiso").dialog('close');
                            data.Errors = ['Ya existe una encuesta abierta para actualización.'];                            
                        }

                        if (data.Errors) {
                            var errors = "";
                            for (var i = 0; i < data.Errors.length; i++) {
                                errors += "<li>" + data.Errors[i] + "</li>";
                            }
                            $("#errors-container-general").removeClass("hidden").find("ul").html(errors);
                            $.smallBox({
                                title: "Error",
                                content: "<i class='fa fa-clock-o'></i> <i>Error al abrir encuesta para actualización</i>",
                                color: "#C46A69",
                                iconSmall: "fa fa-check fa-2x fadeInRight animated",
                                timeout: 4000
                            });
                            window.scrollTo(0, 0);
                        }
                    });
                },
                'Cancelar': function () {
                    $(this).dialog('close');
                }
            },
            create: function () {
                $(this).closest('.ui-dialog')
                    .find('.ui-dialog-buttonpane button')
                    .addClass('btn btn-primary');
                $(this).closest('.ui-dialog')
                    .find('.ui-dialog-buttonpane button:first').attr('id', 'btnBrindarPermiso');
            }
        });

        //$('#btnBrindarPermiso').click(function (e) {
           
        //});
    </script>
}