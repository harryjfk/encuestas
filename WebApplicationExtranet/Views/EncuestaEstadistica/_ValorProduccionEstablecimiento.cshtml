@model Entity.EncuestaEstadistica
@using Domain

<div class="panel panel-primary">
    <div class="panel-heading">Capítulo III: Valor total de la producción mensual del establecimiento</div>
    <div class="panel-body">
        <div id="errors-containervpe" class="alert alert-danger animated bounceIn hidden">
            <strong>Alertas</strong>
            <div>
                <ul></ul>
            </div>
        </div>
        <table class="table table-striped table-hover table-bordered table-condensed tabla small">

            <thead>
                <tr class="cabecera" style="width: 60%">
                    <th>
                        CIIU
                    </th>
                    <th style="width: 20%">
                        Materia prima propia
                    </th>
                    <th style="width: 20%">
                        Materia prima de terceros
                    </th>
                </tr>
            </thead>


            <tbody>
                @foreach (var item in Model.DAT_VALOR_PROD_MENSUAL.OrderBy(t=>t.CAT_CIIU.ToString()))
                {
                    <tr>
                        <td>
                            <input type="hidden" class="valIds" role="@item.Id" />
                            @item.CAT_CIIU.ToString()
                        </td>
                        <td>
                            @Html.Label("", item.ProductosMateriaPropia.GetValueOrDefault().ProduceFormat(), new { @class = "form-control reset-max-width", Value = item.ProductosMateriaPropia.GetValueOrDefault().ProduceFormat() })
                        </td>
                        <td>
                            @if (item.MateriaPrimaTercerosActivada)
                            {
                                @Html.TextBoxFor(modelItem => item.ProductosMateriaTerceros, new { style = "  width: 100%;", @class = "mask4 form-control pmt-" + item.Id, Value = item.ProductosMateriaTerceros.GetValueOrDefault().ProduceFormat() })
                                if (item.justificacion_materia_terc == null)
                                {
                                    <div class="panel justValorProd panel-default pnl-just div-jvmt-@item.Id" style="display: none; margin-top: 5px;">
                                        <span>Justificaci&oacute;n</span>
                                        @Html.TextAreaFor(modelItem => item.justificacion_materia_terc, new { style = " width: 100%;", @class = "form-control jvmt-" + item.Id })
                                    </div>
                                }
                                else
                                {
                                    <div class="panel justValorProd panel-default pnl-just div-jvmt-@item.Id" style="margin-top: 5px;">
                                        <span>Justificaci&oacute;n</span>
                                        @Html.TextAreaFor(modelItem => item.justificacion_materia_terc, new { style = " width: 100%;", @class = "form-control jvmt-" + item.Id })
                                    </div>
                                }
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <div class="pull-right">
            <a href="javascript:void(0);" id="edit-btnPE" data-toggle="tooltip" data-placement="top" title="" data-original-title="Guardar" class="btn btn-primary">Guardar</a>
            
        </div>

        @if (Model.DAT_VALOR_PROD_MENSUAL.Count == 0)
        {
            <div class="no-elements-notification">
                No hay elementos para mostrar
            </div>
        }
    </div>

</div>

<script type="text/javascript">
    $(document).ready(function () {

        $('.justValorProd textarea').each(function (i, el) {
            var value = $(this).val().trim();
            $(this).val(value);
        });

        maskEstadistico();
    });
    $("#edit-btnPE").click(function (e) {
        $(".justValorProd").hide();
        var list = [];
        $(".valIds").each(function (i, el) {
            var $elem = $(el);
            var id = $elem.attr("role");
            var pmp = 0;
            if ($('.pmp-' + id)[0]) {
                pmp = $('.pmp-' + id)[0].value;
            }
            var pmt = null;
            if ($('.pmt-' + id)[0]) {
                pmt = getValueEstadistico('.pmt-' + id);
            }
            var jus = null;
            if ($('.jvmt-' + id)[0])
                jus = $('.jvmt-' + id)[0].value;
            var obj = {
                Id: id,
                ProductosMateriaPropia: pmp,
                ProductosMateriaTerceros: pmt,
                justificacion_materia_terc: jus
            };
            list.push(obj);
        });
        $.ajax({
            cache: false,
            dataType: "json",
            type: "POST",
            contentType: "application/json",
            url: $.origin() + "/EncuestaEstadistica/SaveValorProduccion/",
            data: JSON.stringify({ "valores": list }),
            success: function (data) {
                if (data.Success) {

                    for (var j = 0; j < data.Elements.length; j++) {                        
                        $($('.div-jvmt-' + data.Elements[j])[0]).show();
                    }

                    $("#errors-containervpe").addClass("hidden");
                    $.smallBox({
                        title: "Confirmación",
                        content: "<i class='fa fa-clock-o'></i> <i>El elemento se guardó correctamente</i>",
                        color: "#659265",
                        iconSmall: "fa fa-check fa-2x fadeInRight animated",
                        timeout: 4000
                    });
                } else {
                    var errors = "";
                    for (var i = 0; i < data.Errors.length; i++) {
                        errors += "<li>" + data.Errors[i] + "</li>";
                    }                   
                    $("#errors-containervpe").removeClass("hidden").find("ul").html(errors);
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert('Failed to retrieve data.');
            }
        });
        e.preventDefault();
    });
</script>